@import play.api.libs.json.JsObject
@import play.api.libs.json.JsValue
@import java.text.DecimalFormat
@(currencies: JsObject, srcAmt: String, rates: JsObject, srcCur: String, dstCur: String, error: String)

@main("Simple Exchange") {
    @if(error.isEmpty) {
        <form class="form-inline" action='/' method='get'>
            <div class="input-group">
                <input name="srcAmt" id="srcAmt" type="text" class="form-control conversion-form" placeholder="Enter an amount..." min="0" step="any" required="required" value="@{
                    var fmt = new DecimalFormat("0.00########"); fmt.format(BigDecimal(srcAmt))
                }" />

                <span class="input-group-btn">
                    <select name="srcCur" id="srcCur" class="form-control select select-default conversion" style="visibility : hidden">
                    @for(key <- currencies.keys.toList.sorted) {
                        <option @if(srcCur.startsWith(key)) {
                            selected="selected"
                        } value="@key">
                        @{
                            val s = key + " - " + currencies.value.get(key).get.toString().replace("\"", ""); s
                        }
                        </option>
                    }
                    </select>
                </span>

                <span class="input-group-btn">
                    <button type="button" id="swap-button" class="btn btn-default conversion-form"><span class="glyphicon glyphicon-resize-horizontal" aria-hidden="true"></span></button>
                </span>

                <span class="input-group-btn">
                    <select name="dstCur" id="dstCur" class="form-control select select-default" style="visibility : hidden">
                    @for(key <- currencies.keys.toList.sorted) {
                        <option @if(dstCur.startsWith(key)) {
                            selected="selected"
                        } value="@key">
                        @{
                            val s = key + " - " + currencies.value.get(key).get.toString().replace("\"", ""); s
                        }
                        </option>
                    }
                    </select>
                </span>

                <span class="input-group-btn">
                    <button type="submit" class="btn btn-default conversion-form">Convert!</button>
                </span>
            </div>
        </form>
        <div id="displayArea">
            <span class="display-srcAmt">@{
                val fmt = new DecimalFormat("0.00########"); fmt.format(BigDecimal(srcAmt))
            }</span>
            <span class="display-srcCur">@srcCur</span>
            <span class="display-eq">=</span>
            <span class="display-dstAmt">@{
                if (rates == null) {
                    "ERR"
                } else {
                    import play.api.Play.current
                    implicit val context = play.api.libs.concurrent.Execution.Implicits.defaultContext
                    import play.api.cache.Cache

                    Cache.set("rates", rates)
                    val srcCurVal: BigDecimal = rates.value.get(srcCur).map(t => BigDecimal(t.toString)).orNull
                    val dstCurVal: BigDecimal = rates.value.get(dstCur).map(t => BigDecimal(t.toString)).orNull
                    if(srcCurVal != null && dstCurVal != null) {
                        val fmt = new DecimalFormat("0.00########")
                        fmt.format(BigDecimal(srcAmt) * dstCurVal / srcCurVal)
                    } else {
                        "ERR"
                    }
                }
            }</span>
            <span class="display-srcCur">@dstCur</span>
        </div>
    } else {
        <div id="displayArea">
            <div style="color: #e74c3c;font-weight: bolder;">Oops, there was a problem!</div>
            <div style="color: #1abc9c;margin-top: 20px">@error</div>
            <div style="margin-top: 20px">
                <a href="/" type="button" class="btn btn-default conversion-form">Try Again</a>
            </div>
        </div>
    }
}
